From abb872a7fd7d286471c1c469ddb2bdb32a1edbb8 Mon Sep 17 00:00:00 2001
From: Sam Nazarko <email@samnazarko.co.uk>
Date: Fri, 10 Apr 2015 03:43:11 +0100
Subject: [PATCH] More logging for i.MX window bringup and some test
 workarounds

Signed-off-by: Sam Nazarko <email@samnazarko.co.uk>
---
 xbmc/utils/SysfsUtils.cpp               |  2 +-
 xbmc/windowing/egl/EGLNativeTypeIMX.cpp | 16 +++++++++++++++-
 2 files changed, 16 insertions(+), 2 deletions(-)

diff --git a/xbmc/utils/SysfsUtils.cpp b/xbmc/utils/SysfsUtils.cpp
index ca62986..87b2cc2 100644
--- a/xbmc/utils/SysfsUtils.cpp
+++ b/xbmc/utils/SysfsUtils.cpp
@@ -29,7 +29,7 @@
 
 int SysfsUtils::SetString(const std::string& path, const std::string& valstr)
 {
-  int fd = open(path.c_str(), O_CREAT | O_RDWR | O_TRUNC, 0644);
+  int fd = open(path.c_str(), O_CREAT | O_RDWR | O_TRUNC | O_SYNC, 0644);
   if (fd >= 0)
   {
     write(fd, valstr.c_str(), valstr.size());
diff --git a/xbmc/windowing/egl/EGLNativeTypeIMX.cpp b/xbmc/windowing/egl/EGLNativeTypeIMX.cpp
index 8b5ec68..ab8b4ac 100644
--- a/xbmc/windowing/egl/EGLNativeTypeIMX.cpp
+++ b/xbmc/windowing/egl/EGLNativeTypeIMX.cpp
@@ -244,14 +244,28 @@ bool CEGLNativeTypeIMX::SetNativeResolution(const RESOLUTION_INFO &res)
 
   std::string mode;
   SysfsUtils::GetString("/sys/class/graphics/fb0/mode", mode);
+  CLog::Log(LOGDEBUG, "%s%s%s%s", "res.strID = ", res.strId.c_str(), " and mode is ", mode.c_str());
   if (res.strId == mode)
+  {
+	CLog::Log(LOGDEBUG, "%s", "Not going to SetNativeResolution, because mode seems to already be matching");
     return false;
+  }
 
   DestroyNativeWindow();
   DestroyNativeDisplay();
 
   SysfsUtils::SetString("/sys/class/graphics/fb0/mode", res.strId + "\n");
-
+  SysfsUtils::GetString("/sys/class/graphics/fb0/mode", mode);
+  if (res.strId == mode)
+	CLog::Log(LOGDEBUG, "%s", "Mode was changed successfully");
+  else
+  {
+	CLog::Log(LOGDEBUG, "%s", "Mode was not changed successfully");
+	CLog::Log(LOGDEBUG, "%s%s", "fb0 mode is ", mode.c_str());
+	CLog::Log(LOGDEBUG, "%s", "Going to chown to osmc user and try again..");
+	system("/usr/bin/sudo /bin/chown osmc:osmc /sys/class/graphics/fb0/mode");
+	SysfsUtils::SetString("/sys/class/graphics/fb0/mode", res.strId + "\n");
+  }
   CreateNativeDisplay();
 
   CLog::Log(LOGDEBUG, "%s: %s",__FUNCTION__, res.strId.c_str());
-- 
2.1.0

