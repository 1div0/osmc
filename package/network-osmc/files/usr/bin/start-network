#!/bin/bash

# (c) 2014-2015 Sam Nazarko
# email@samnazarko.co.uk

if grep -q nfsroot /proc/cmdline
then
	if ! grep -q MANUAL /proc/net/pnp
	then
		cp /proc/net/pnp /etc/resolv.conf
		cp /proc/sys/kernel/hostname /etc/hostname
		hostname=$(cat /etc/hostname)
		hostline="127.0.0.1		${hostname}"
		if ! grep -q $hostline /etc/hosts
		then
			echo $hostline >> /etc/hosts
		fi
	else
		nameservers=$(dmesg | egrep -o 'nameserver[0-9][0-9]* *= *[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$' | awk -F= '{print $NF}') >/etc/resolv.conf
		for ns in ${nameservers[@]}
		do
			if ! grep -w "$ns" /etc/resolv.conf
			then
				echo "nameserver ${ns}" >> /etc/resolv.conf
			fi
		done
	fi
	exec /usr/sbin/connmand -n -I eth0 --nodnsproxy --config=/etc/connman.conf
else
	exec /usr/sbin/connmand -n --config=/etc/connman.conf
fi

